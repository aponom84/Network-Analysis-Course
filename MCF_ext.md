## Потоковая Multi-Commodity Flow нелинейной стоимостью с учётом перегруза в промежуточных узлах

### Дано:
- Ориентированный граф $ G = (V, E) $
- Множество товаров (commodities) $ K $
- Для каждого товара $ k \in K $: источник $ s_k $, сток $ t_k $, требуемый поток $ d_k $
- Для каждого ребра $ e \in E $: пропускная способность $ u_e $, стоимость использования одним ТС $ c_e $, вместимость ТС $ C $
- Для каждого узла $ v \in V $:
  - $ f_v \in \mathbb{R}_+ $ — стоимость перегруза единицы груза в узле $ v $
  - $ U_v^- \in \mathbb{R}_+ $ — максимальная пропускная способность по входящим потокам
  - $ U_v^+ \in \mathbb{R}_+ $ — максимальная пропускная способность по исходящим потокам

### Переменные:
- $ x^k_e \in \mathbb{R}_+ $ — поток товара $ k $ через ребро $ e \in E $
- $ y_e \in \mathbb{Z}_+ $ — количество ТС, используемых на ребре $ e \in E $

---

### Целевая функция:
$$
\min \left( \sum_{e \in E} c_e \cdot y_e + \sum_{v \in V} f_v \cdot \sum_{\substack{k \in K \\ v \neq s_k \\ v \neq t_k}} \sum_{e \in \delta^-(v)} x^k_e \right)
$$

Стоимость перегруза учитывается **только для транзитных товаров** — тех, для которых узел $ v $:
- Не является источником ($ v \neq s_k $)
- Не является стоком ($ v \neq t_k $)

---

### Ограничения:

1. **Баланс потока для каждого товара и узла:**
   $$
   \sum_{e \in \delta^+(v)} x^k_e - \sum_{e \in \delta^-(v)} x^k_e = 
   \begin{cases} 
   d_k & \text{если } v = s_k, \\
   -d_k & \text{если } v = t_k, \\
   0 & \text{иначе}
   \end{cases}
   \quad \forall k \in K, \, \forall v \in V
   $$
   где $ \delta^-(v) = \{ e \in E \mid \text{head}(e) = v \} $, $ \delta^+(v) = \{ e \in E \mid \text{tail}(e) = v \} $.

2. **Ограничение пропускной способности рёбер:**
   $$
   \sum_{k \in K} x^k_e \leq u_e \quad \forall e \in E
   $$

3. **Связь между потоком и количеством ТС:**
   $$
   \sum_{k \in K} x^k_e \leq C \cdot y_e \quad \forall e \in E, \quad y_e \in \mathbb{Z}_+
   $$

4. **Ограничение пропускной способности по входящим потокам (складская разгрузка):**
   $$
   \sum_{k \in K} \sum_{e \in \delta^-(v)} x^k_e \leq U_v^- \quad \forall v \in V
   $$

5. **Ограничение пропускной способности по исходящим потокам (складская загрузка):**
   $$
   \sum_{k \in K} \sum_{e \in \delta^+(v)} x^k_e \leq U_v^+ \quad \forall v \in V
   $$

6. **Неотрицательность потоков:**
   $$
   x^k_e \geq 0 \quad \forall e \in E, \, \forall k \in K
   $$


## Путевая Multi-Commodity Flow модель с нелинейной стоимостью и учётом перегруза в промежуточных узлах

### Дано:
- Ориентированный граф $ G = (V, E) $
- Множество товаров (commodities) $ K $
- Для каждого товара $ k \in K $: источник $ s_k $, сток $ t_k $, требуемый поток $ d_k $
- Для каждого ребра $ e \in E $: пропускная способность $ u_e $, стоимость использования одним ТС $ c_e $, вместимость ТС $ C $
- Для каждого узла $ v \in V $:
  - $ f_v \in \mathbb{R}_+ $ — стоимость перегруза единицы груза в узле $ v $
  - $ U_v^- \in \mathbb{R}_+ $ — максимальная пропускная способность по входящим потокам
  - $ U_v^+ \in \mathbb{R}_+ $ — максимальная пропускная способность по исходящим потокам
- Для каждого товара $ k \in K $: $ \Pi_k $ — множество всех возможных путей из $ s_k $ в $ t_k $ в графе $ G $

---

### Переменные:
- $ x^k_p \in \mathbb{R}_+ $ — поток товара $ k $ по пути $ p \in \Pi_k $
- $ y_e \in \mathbb{Z}_+ $ — количество ТС, используемых на ребре $ e \in E $

---

### Целевая функция:
$$
\min \left( 
\sum_{e \in E} c_e \cdot y_e + 
\sum_{k \in K} \sum_{p \in \Pi_k}  \sum_{\substack{v \in p \\ v \neq s_k \\ v \neq t_k}}  f_v \cdot x^k_p 
\right)
$$

**Пояснение:**
- Первое слагаемое — суммарная стоимость использования ТС на рёбрах.
- Второе слагаемое — стоимость перегруза **только для транзитных узлов**, т.е. когда узел $ v $:
  - Не является источником ($ v \neq s_k $)
  - Не является стоком ($ v \neq t_k $)
  - Путь $ p $ проходит через узел $ v $ ($ v \in p $)

---

### Ограничения:

1. **Полный поток для каждого товара:**
   $$
   \sum_{p \in \Pi_k} x^k_p = d_k \quad \forall k \in K
   $$
   *Обеспечивает удовлетворение спроса для каждого товара.*

2. **Пропускная способность рёбер:**
   $$
   \sum_{k \in K} \sum_{p \in \Pi_k : e \in p} x^k_p \leq u_e \quad \forall e \in E
   $$
   *Суммарный поток по ребру $ e $ не превышает его пропускную способность.*

3. **Связь между потоком и количеством ТС:**
   $$
   \sum_{k \in K} \sum_{p \in \Pi_k : e \in p} x^k_p \leq C \cdot y_e \quad \forall e \in E, \quad y_e \in \mathbb{Z}_+
   $$
   *Количество ТС $ y_e $ определяется суммарным потоком на ребре $ e $.*

4. **Ограничение входящей пропускной способности узлов:**
   $$
   \sum_{k \in K : v \neq s_k}\sum_{p \in \Pi_k : v \in p} x^k_p \leq U_v^- \quad \forall v \in V
   $$
   *Суммарный входящий поток в узел $ v $ (кроме случаев, когда $ v $ — источник товара) не превышает $ U_v^- $.*

5. **Ограничение исходящей пропускной способности узлов:**
   $$
   \sum_{\substack{k \in K : v \neq t_k}} \sum_{\substack{p \in \Pi_k : v \in p}} x^k_p \leq U_v^+ \quad \forall v \in V
   $$
   *Суммарный исходящий поток из узла $ v $ (кроме случаев, когда $ v $ — сток товара) не превышает $ U_v^+ $.*

6. **Неотрицательность потоков:**
   $$
   x^k_p \geq 0 \quad \forall k \in K, \, \forall p \in \Pi_k
   $$

---

### Ключевые особенности путевой формулировки:
1. **Переменные потока определены на путях**, а не на рёбрах:
   - $ x^k_p $ заменяет $ x^k_e $ исходной потоковой модели, что позволяет явно учитывать маршруты доставки.
   - Узловые ограничения (4–5) и целевая функция выражаются через принадлежность узла $ v $ пути $ p $.

2. **Учёт перегруза только для транзитных узлов**:
   - В целевой функции и ограничениях (4–5) суммирование по $ k $ ограничено условиями $ v \neq s_k $ и $ v \neq t_k $.
   - Это гарантирует, что стоимость перегруза не начисляется для источников и стоков.

3. **Сохранение целочисленности ТС**:
   - Переменные $ y_e $ остаются целочисленными, так как количество ТС не может быть дробным.

4. **Эквивалентность исходной модели**:
   - Все ограничения исходной потоковой модели корректно преобразованы в терминах путей.
   - Баланс потока обеспечивается автоматически через условие $ \sum_{p \in \Pi_k} x^k_p = d_k $.

> **Примечание:** На практике множество путей $ \Pi_k $ может быть очень большим. Для решения задачи рекомендуется использовать методы column generation, где пути добавляются динамически в процессе оптимизации. Обозначение $ x^k_p $ подчеркивает, что переменные относятся к потоку товара $ k $ по конкретному пути $ p $ (в отличие от $ x^k_e $ в рёберной формулировке).