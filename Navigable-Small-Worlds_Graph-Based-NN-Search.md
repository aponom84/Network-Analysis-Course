### **Навигационные тесные миры – графовые методы для поиска ближайшего соседа: NSW и HNSW**

#### **Цель лекции:**
Познакомить студентов с современными графовыми подходами к эффективному поиску ближайших соседей в многомерных пространствах, основанными на принципах "навигационных тесных миров", и показать, как сетевые структуры могут использоваться для решения прикладных задач машинного обучения и анализа данных.

---

### **1. Введение: задача поиска ближайшего соседа (Nearest Neighbor Search, NNS)**
- Постановка задачи:
  - Дано множество точек в многомерном пространстве.
  - Найти \( k \) ближайших к запросу точек по метрике (например, евклидовой, косинусной).
- Применения:
  - Рекомендательные системы.
  - Поиск похожих изображений/текстов.
  - Кластеризация, классификация (kNN).
  - Информационный поиск.
- Проблема "проклятия размерности": традиционные методы (линейный перебор, деревья) становятся неэффективны при высокой размерности.

---

### **2. Приближённый поиск ближайшего соседа (Approximate Nearest Neighbor, ANN)**
- Почему нужен приближённый поиск?
  - Точность vs. скорость: компромисс между качеством и вычислительной сложностью.
  - Требования к масштабируемости (миллионы/миллиарды точек).
- Подходы к ANN:
  - LSH (Locality-Sensitive Hashing).
  - Методы на основе деревьев (KD-tree, Annoy).
  - **Графовые методы** — фокус лекции.

---

### **3. Идея графовых методов: поиск по графу ближайших соседей**
- Представление данных как граф:
  - Вершины — векторы (объекты).
  - Рёбра — связи с "близкими" или "полезными" соседями.
- Поиск = обход графа от случайной стартовой вершины к цели.
- Преимущества:
  - Логарифмическая или сублинейная сложность поиска.
  - Хорошее качество приближения.
  - Поддержка динамических вставок (в некоторых вариантах).

---

### **4. Модель "Навигационный тесный мир" (Navigable Small World, NSW)**

#### **4.1. Теоретические основы**
- Источник: работа М. Криволапова (2011), вдохновлена моделями "малого мира" (Watts–Strogatz).
- Ключевая идея:
  - Сеть должна быть **навигационной**, т.е. по ней можно эффективно искать кратчайший путь **жадным алгоритмом** (на каждом шаге переходим к ближайшему к цели соседу).
- Условие навигационности:
  - Наличие как локальных (для кластеризации), так и длинных связей (для быстрого перехода между кластерами).

#### **4.2. Построение графа NSW**
- Алгоритм:
  1. Добавляем точки по одной.
  2. Для новой точки \( q \):
     - Запускаем жадный поиск по уже построенному графу.
     - Находим \( k \) ближайших к \( q \) вершин.
     - Соединяем \( q \) с ними.
- Структура:
  - Высокая кластеризация (локальные связи).
  - Наличие "длинных рёбер" (мосты между кластерами) — обеспечивают малый диаметр.

#### **4.3. Алгоритм поиска в NSW**
- Жадный обход:
  - Начинаем с случайной вершины.
  - На каждом шаге переходим к соседу, ближайшему к запросу.
  - Останавливаемся, когда ни один сосед не ближе текущей вершины.
- Результат — приближённый ближайший сосед.
- Многократный запуск с разных стартов повышает точность.

#### **4.4. Свойства NSW**
- Средняя сложность поиска: \( O(\log n) \).
- Качество поиска высокое при разумной плотности графа.
- Не поддерживает эффективное удаление узлов.
- Может деградировать при динамическом обновлении.

---

### **5. Улучшенная модель: HNSW (Hierarchical Navigable Small World)**

#### **5.1. Проблемы NSW и мотивация HNSW**
- NSW: один уровень графа → компромисс между скоростью и точностью.
- HNSW (Yury Malkov, Dmitry Yashunin, 2016):
  - Многоуровневая иерархическая структура.
  - Быстрый вход на верхних уровнях, точный поиск на нижних.

#### **5.2. Архитектура HNSW**
- Многоуровневый граф:
  - Верхний уровень: мало вершин, длинные рёбра — "грубая навигация".
  - Нижний уровень: все вершины, плотные связи — "точный поиск".
- При вставке:
  - Каждая вершина случайно добавляется на несколько уровней (по экспоненциальному распределению).
- Поиск:
  1. Начинаем на верхнем уровне.
  2. Жадно спускаемся до локального минимума.
  3. Спускаемся на следующий уровень, используя найденную точку как старт.
  4. Повторяем до самого нижнего уровня.

#### **5.3. Преимущества HNSW**
- Очень высокая скорость поиска (сравнима с лучшими ANN-библиотеками).
- Высокая точность при настройке параметров.
- Поддержка вставок (но не удалений) в реальном времени.
- Эффективность в пространствах высокой размерности (100+).

#### **5.4. Параметры HNSW**
- `M` — максимальная степень вершины (плотность связей).
- `ef_construction` — параметр качества построения (чем выше, тем точнее, но медленнее).
- `ef_search` — параметр качества поиска (аналогично).
- `ef` — trade-off между скоростью и точностью.

---

### **6. Практическое применение и реализации**
- HNSW — ядро многих современных систем:
  - FAISS (Facebook AI Similarity Search).
  - Annoy (Spotify).
  - Vespa, Weaviate, Milvus — системы векторного поиска.
- Примеры использования:
  - Поиск дубликатов изображений.
  - Рекомендации на основе эмбеддингов.
  - Поиск по семантическим векторам (BERT, Sentence-BERT).

---

### **7. Сравнение NSW и HNSW**
| Характеристика       | NSW                          | HNSW                                  |
|----------------------|------------------------------|----------------------------------------|
| Структура            | Одноуровневый граф           | Многоуровневый граф                   |
| Скорость поиска      | \( O(\log n) \)              | \( O(\log \log n) \) — быстрее         |
| Точность             | Средняя                      | Высокая (настраивается)               |
| Объём памяти         | Умеренный                    | Выше (из-за иерархии)                  |
| Поддержка вставок    | Да                           | Да                                     |
| Удаление узлов       | Проблематично                | Не поддерживается                     |
| Реализации           | Research, редко в продакшене | Широко используется (FAISS, Milvus)   |

---

### **8. Заключение**
- Графовые методы (NSW, HNSW) — мощный инструмент для масштабируемого поиска ближайших соседей.
- Основаны на принципах малого мира и эффективной навигации.
- HNSW стал *де-факто* стандартом в задачах ANN благодаря сочетанию скорости, точности и простоты реализации.
- Показывает, как абстрактные модели сетей находят прямое применение в современных ИТ-системах.

---

### **Демонстрация (по желанию)**
- Визуализация обхода графа NSW при поиске.
- Сравнение времени поиска в HNSW при разных `ef_search`.
- Пример кода на Python с использованием `nmslib` или `faiss`.

---

### **Рекомендуемая литература:**
1. Malkov, Y., & Yashunin, D. *Efficient and robust approximate nearest neighbor search using Hierarchical Navigable Small World graphs*. IEEE TPAMI, 2018.  
2. Kleinberg, J. *Navigation in a small world*. Nature, 2000.  
3. Documentation: [FAISS](https://github.com/facebookresearch/faiss), [NMSLIB](https://github.com/nmslib/nmslib).  
4. Blog: *"How does HNSW work?"* — Towards Data Science.

---

### **Вопросы для самопроверки:**
1. Почему граф NSW называется "навигационным"?
2. Как работает жадный алгоритм поиска в графе?
3. Зачем в HNSW используется иерархия уровней?
4. Как параметр `ef_search` влияет на производительность и точность?
5. В каких прикладных задачах особенно эффективен HNSW?